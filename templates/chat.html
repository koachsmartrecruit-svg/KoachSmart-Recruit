{% extends "base.html" %}
{% block content %}

<style>
.chat-container{
  height: calc(100vh - 140px);
  display: flex;
  background: #ffffff;
}
.contacts-sidebar{
  width: 280px;
  background: #f8fafc;
  border-right: 1px solid #e5e7eb;
  overflow-y: auto;
}
.contact-item{
  display: flex;
  gap: 12px;
  padding: 12px;
  text-decoration: none;
  color: #0f172a;
  border-bottom: 1px solid #e5e7eb;
}
.contact-item.active{
  background: #e0edff;
}
.avatar{
  width: 42px;
  height: 42px;
  border-radius: 10px;
  background: #2563eb;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}
.chat-area{
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}
.chat-header{
  padding: 14px;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 600;
}
.messages-box{
  flex: 1;
  padding: 18px;
  overflow-y: auto;
  background: #f1f5f9;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.message{
  max-width: 65%;
  padding: 12px 14px;
  border-radius: 14px;
  font-size: 0.95rem;
  word-break: break-word;
}
.sent{
  align-self: flex-end;
  background: #2563eb;
  color: #fff;
  border-bottom-right-radius: 4px;
}
.received{
  align-self: flex-start;
  background: #e5e7eb;
  border-bottom-left-radius: 4px;
}
.msg-time{
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 4px;
  text-align: right;
}
.chat-input-area{
  padding: 12px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  gap: 8px;
  background: #fff;
}
.chat-input-area input[type=text]{
  flex: 1;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
}
.chat-input-area button{
  width: 44px;
  height: 44px;
  border-radius: 10px;
}
.chat-empty{
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
}
</style>

<div class="chat-container">

  <!-- SIDEBAR -->
  <div class="contacts-sidebar">
    <div class="p-3 border-bottom"><strong>Messages</strong></div>

    {% for u in contacts %}
      <a href="{{ url_for('chat.chat_with_user', user_id=u.id) }}"
         class="contact-item {% if active_contact and active_contact.id == u.id %}active{% endif %}">
        <div class="avatar">{{ u.username[0]|upper }}</div>
        <div>
          <strong>{{ u.username }}</strong><br>
          <small>{{ u.role }}</small>
        </div>
      </a>
    {% endfor %}
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area">

    {% if active_contact %}

      <div class="chat-header">
        {{ active_contact.username }}
      </div>

      <div class="messages-box" id="messagesBox">
        {% for msg in messages %}
          <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
            {% if msg.content.startswith('[file]') %}
              <a href="{{ msg.content[6:] }}" target="_blank">ðŸ“Ž View attachment</a>
            {% else %}
              {{ msg.content }}
            {% endif %}
            <div class="msg-time">{{ msg.timestamp.strftime('%I:%M %p') }}</div>
          </div>
        {% endfor %}
      </div>

      <div class="chat-input-area">
        <input id="messageInput" type="text" placeholder="Type a messageâ€¦">
        <input id="fileInput" type="file" hidden>
        <button type="button" id="attachBtn">ðŸ“Ž</button>
        <button type="button" id="sendBtn" class="btn btn-primary">âž¤</button>
      </div>


    {% else %}

      <div class="chat-empty">
        Select a conversation to start chatting
      </div>

    {% endif %}
  </div>
</div>
<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>

{% if active_contact %}
<script>
const socket = io();
const room = {{ room | tojson }};
const receiverId = {{ active_contact.id }};
const box = document.getElementById('messagesBox');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const attachBtn = document.getElementById('attachBtn');

// Join room
socket.emit('join', { room });

// Helper to add a bubble
function appendMessage(content, isMe, timeStr){
  const div = document.createElement('div');
  div.className = 'message ' + (isMe ? 'sent' : 'received');

  if (content.startsWith('[file]')) {
    const url = content.slice(6);
    div.innerHTML = `<span>Attachment: </span><a href="${url}" target="_blank">Open file</a>`;
  } else {
    div.textContent = content;
  }

  const t = document.createElement('div');
  t.className = 'msg-time';
  t.textContent = timeStr || '';
  div.appendChild(t);

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// Click on send button
sendBtn.onclick = () => {
  const text = input.value.trim();
  if (!text) return;

  socket.emit('send_message', {
    room,
    receiver_id: receiverId,
    message: text
  });

  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  appendMessage(text, true, timeStr);
  input.value = '';
};

// 1) Press Enter to send
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    sendBtn.onclick();
  }
});

// Receive message from server
socket.on('receive_message', data => {
  if (data.sender_id !== {{ current_user.id }}) {
    appendMessage(data.content, false, data.timestamp);
  }
});

// Open file picker
attachBtn.onclick = () => {
  fileInput.click();
};

// 2) Upload file and show attachment bubble
fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append('file', file);
  fd.append('receiver_id', receiverId);

  const res = await fetch('{{ url_for("chatupload") }}', {
    method: 'POST',
    body: fd
  });

  const data = await res.json();
  fileInput.value = '';

  if (data.url) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    appendMessage('[file]' + data.url, true, timeStr);
  }
};
</script>
{% endif %}

{% endblock %}
