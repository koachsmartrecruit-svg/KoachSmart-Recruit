{% extends "base.html" %}
{% block title %}Coach Onboarding{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 820px;">

    <!-- HEADER -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">Coach Onboarding</h2>
        <p class="text-muted">Complete all steps to earn <strong>200 coins</strong> and unlock your dashboard</p>
    </div>

    <!-- PROGRESS -->
    <div class="mb-4">
        <div class="d-flex justify-content-between mb-1">
            <small>Step {{ current_step }} of 3</small>
            <small>{{ progress.progress_percentage | int }}%</small>
        </div>
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-warning"
                 style="width: {{ progress.progress_percentage }}%"></div>
        </div>
    </div>

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- ================= STEP 1 ================= -->
    {% if current_step == 1 %}
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <h5 class="mb-3">Step 1: Personal Details & Verification</h5>

            <form method="POST">
                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">First Name *</label>
                        <input type="text" name="first_name" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Last Name *</label>
                        <input type="text" name="last_name" class="form-control" required>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Phone Number *</label>
                        <div class="input-group">
                            <span class="input-group-text">+91</span>
                            <input type="text" name="phone" class="form-control" maxlength="10" required>
                            <button class="btn btn-outline-warning" name="send_phone_otp" type="submit">
                                Send OTP
                            </button>
                        </div>
                        <small class="text-muted">Demo OTP: <strong>123456</strong></small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Phone OTP *</label>
                        <input type="text" name="phone_otp" class="form-control" maxlength="6" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email OTP *</label>
                        <input type="text" name="email_otp" class="form-control" maxlength="6" required>
                    </div>

                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-warning px-4">
                        Verify & Continue â†’
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- ================= STEP 2 ================= -->
    {% if current_step == 2 %}
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <h5 class="mb-3">Step 2: Location & Coaching Info</h5>

            <form method="POST">
                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">State *</label>
                        <input type="text" name="state" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">City *</label>
                        <input type="text" name="city" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Primary Sport *</label>
                        <input type="text" name="sport" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Coaching Experience *</label>
                        <select name="experience_years" class="form-select" required>
                            <option value="">Select</option>
                            <option value="0">Fresher</option>
                            <option value="1">1â€“2 Years</option>
                            <option value="3">3â€“5 Years</option>
                            <option value="5">5+ Years</option>
                        </select>
                    </div>

                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-warning px-4">
                        Save & Continue â†’
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- ================= STEP 3 ================= -->
    {% if current_step == 3 %}
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <h5 class="mb-3">Step 3: Education Certificate</h5>

            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Upload Certificate *</label>
                    <input type="file" name="certificate" class="form-control" accept=".pdf,.jpg,.png" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Working Type *</label>
                    <select name="working_type" id="working_type" class="form-select" required>
                        <option value="">Select</option>
                        <option value="full_time">Full Time</option>
                        <option value="part_time">Part Time</option>
                        <option value="session">Session Based</option>
                    </select>
                </div>
                <div class="col-12" id="radiusBlock" style="display:none;">
                    <label class="form-label">Service Radius *</label>
                    <select name="service_radius" class="form-select">
                        <option value="">Select Radius</option>
                        <option value="5">Up to 5 KM</option>
                        <option value="10">Up to 10 KM</option>
                        <option value="15">Up to 15 KM</option>
                        <option value="20">Up to 20 KM</option>
                        <option value="30">Up to 30 KM</option>
                        <option value="50">Up to 50 KM</option>
                        <option value="999">Anywhere</option>
                    </select>

                    <small class="text-muted">
                        Please select where you can deliver coaching.  
                        Incorrect selection may affect ratings.
                    </small>
                </div>

                <div class="alert alert-warning">
                    ðŸŽ‰ Complete this step to earn <strong>200 coins</strong> and your
                    <strong>Orange Badge</strong>.
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-success px-4">
                        Complete Onboarding âœ”
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

</div>
<script>
const workingTypeSelect = document.getElementById("working_type");
const radiusBlock = document.getElementById("radiusBlock");

workingTypeSelect.addEventListener("change", function () {
    if (this.value === "full_time" || this.value === "part_time") {
        radiusBlock.style.display = "block";
    } else {
        radiusBlock.style.display = "none";
    }
});
async function loadStates() {
    const stateSelect = document.getElementById("state");
    stateSelect.innerHTML = `<option>Loading...</option>`;

    try {
        const res = await fetch("/api/states?country=IN");
        const data = await res.json();

        if (!data.success) {
            throw new Error("API failed");
        }

        stateSelect.innerHTML = `<option value="">Select State</option>`;
        data.data.forEach(state => {
            stateSelect.innerHTML +=
                `<option value="${state.id}">${state.name}</option>`;
        });
    } catch (err) {
        console.error(err);
        stateSelect.innerHTML =
            `<option value="">Error loading states</option>`;
    }
}

document.addEventListener("DOMContentLoaded", loadStates);
</script>

{% endblock %}
