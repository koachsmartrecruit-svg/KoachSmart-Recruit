{% extends "base.html" %}
{% block title %}My Profile - Coach Journey{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Profile Header -->
        <div class="col-12">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            {% if current_user.profile_pic %}
                                <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" 
                                     class="rounded-circle img-fluid" style="width: 100px; height: 100px; object-fit: cover;">
                            {% else %}
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 100px; height: 100px;">
                                    <i class="fas fa-user fa-2x text-white"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h3 class="mb-1">{{ profile.full_name or current_user.username }}</h3>
                            <p class="text-muted mb-2">
                                <i class="fas fa-medal me-1"></i>
                                {{ profile.sport or 'Sports Coach' }}
                                {% if profile.sport2 %} & {{ profile.sport2 }}{% endif %}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ profile.city or 'Location not set' }}
                                {% if profile.state %}, {{ profile.state }}{% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="row g-2 text-center">
                                <div class="col-4">
                                    <div class="bg-warning bg-opacity-10 p-2 rounded">
                                        <div class="fw-bold text-warning">{{ current_user.coins or 0 }}</div>
                                        <small class="text-muted">Coins</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-info bg-opacity-10 p-2 rounded">
                                        <div class="fw-bold text-info">{{ current_user.points or 0 }}</div>
                                        <small class="text-muted">Points</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-success bg-opacity-10 p-2 rounded">
                                        <div class="fw-bold text-success">{{ profile.views or 0 }}</div>
                                        <small class="text-muted">Views</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Journey Progress -->
        <div class="col-lg-8">
            
            <!-- Badges Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-trophy text-warning me-2"></i>
                        My Badges & Achievements
                    </h5>
                    
                    {% if user_badges %}
                    <div class="row g-3 mb-3">
                        {% for badge in user_badges %}
                        {% if badge.strip() %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                {% if 'Orange' in badge %}
                                    <i class="fas fa-medal text-warning fa-2x me-3"></i>
                                {% elif 'Purple' in badge %}
                                    <i class="fas fa-medal text-purple fa-2x me-3" style="color: #6f42c1;"></i>
                                {% elif 'Blue' in badge %}
                                    <i class="fas fa-medal text-primary fa-2x me-3"></i>
                                {% elif 'Green' in badge %}
                                    <i class="fas fa-medal text-success fa-2x me-3"></i>
                                {% else %}
                                    <i class="fas fa-award text-secondary fa-2x me-3"></i>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ badge.strip() }}</div>
                                    <small class="text-muted">Earned</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No badges earned yet. Complete your verification journey to earn badges!</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Verification Journey -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-route text-primary me-2"></i>
                        My Verification Journey
                    </h5>

                    <!-- Stage 1: Orange Badge -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            {% if journey_data.stage_1.completed %}
                                <i class="fas fa-check-circle text-success fa-lg me-3"></i>
                            {% else %}
                                <i class="fas fa-clock text-warning fa-lg me-3"></i>
                            {% endif %}
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Stage 1: Basic Verification 
                                    {% if journey_data.stage_1.badge %}
                                        <span class="badge bg-warning ms-2">{{ journey_data.stage_1.badge }}</span>
                                    {% endif %}
                                </h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" 
                                         style="width: {{ (journey_data.stage_1.score / journey_data.stage_1.max_score * 100) }}%"></div>
                                </div>
                                <small class="text-muted">
                                    {{ journey_data.stage_1.score }}/{{ journey_data.stage_1.max_score }} completed
                                    • {{ journey_data.stage_1.coins }} coins earned
                                </small>
                            </div>
                        </div>
                        
                        <div class="row g-2 ms-4">
                            {% for item in journey_data.stage_1.checklist %}
                            <div class="col-md-6">
                                <small class="d-flex align-items-center">
                                    {% if item.status %}
                                        <i class="fas fa-check text-success me-2"></i>
                                    {% else %}
                                        <i class="fas fa-times text-danger me-2"></i>
                                    {% endif %}
                                    {{ item.name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Stage 2: Purple Badge -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            {% if journey_data.stage_2.completed %}
                                <i class="fas fa-check-circle text-success fa-lg me-3"></i>
                            {% else %}
                                <i class="fas fa-clock text-warning fa-lg me-3"></i>
                            {% endif %}
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Stage 2: Location & Service Setup
                                    {% if journey_data.stage_2.badge %}
                                        <span class="badge ms-2" style="background-color: #6f42c1;">{{ journey_data.stage_2.badge }}</span>
                                    {% endif %}
                                </h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" style="background-color: #6f42c1; width: {{ (journey_data.stage_2.score / journey_data.stage_2.max_score * 100) }}%"></div>
                                </div>
                                <small class="text-muted">
                                    {{ journey_data.stage_2.score }}/{{ journey_data.stage_2.max_score }} completed
                                    • {{ journey_data.stage_2.coins }} coins earned
                                </small>
                            </div>
                        </div>
                        
                        <div class="row g-2 ms-4">
                            {% for item in journey_data.stage_2.checklist %}
                            <div class="col-md-6">
                                <small class="d-flex align-items-center">
                                    {% if item.status %}
                                        <i class="fas fa-check text-success me-2"></i>
                                    {% else %}
                                        <i class="fas fa-times text-danger me-2"></i>
                                    {% endif %}
                                    {{ item.name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Stage 3: Blue Badge -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            {% if journey_data.stage_3.completed %}
                                <i class="fas fa-check-circle text-success fa-lg me-3"></i>
                            {% else %}
                                <i class="fas fa-clock text-warning fa-lg me-3"></i>
                            {% endif %}
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Stage 3: Education & Professional
                                    {% if journey_data.stage_3.badge %}
                                        <span class="badge bg-primary ms-2">{{ journey_data.stage_3.badge }}</span>
                                    {% endif %}
                                </h6>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-primary" 
                                         style="width: {{ (journey_data.stage_3.score / journey_data.stage_3.max_score * 100) }}%"></div>
                                </div>
                                <small class="text-muted">
                                    {{ journey_data.stage_3.score }}/{{ journey_data.stage_3.max_score }} completed
                                    • {{ journey_data.stage_3.coins }} coins earned
                                </small>
                            </div>
                        </div>
                        
                        <div class="row g-2 ms-4">
                            {% for item in journey_data.stage_3.checklist %}
                            <div class="col-md-6">
                                <small class="d-flex align-items-center">
                                    {% if item.status %}
                                        <i class="fas fa-check text-success me-2"></i>
                                    {% else %}
                                        <i class="fas fa-times text-danger me-2"></i>
                                    {% endif %}
                                    {{ item.name }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Continue Journey Button -->
                    {% if not current_user.onboarding_completed %}
                    <div class="text-center mt-4">
                        <a href="{{ url_for('onboarding.onboarding_unified') }}" class="btn btn-primary">
                            <i class="fas fa-arrow-right me-2"></i>
                            Continue My Journey
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Documents Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-file-alt text-info me-2"></i>
                        My Documents
                    </h5>
                    
                    {% if documents %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Document Type</th>
                                    <th>Uploaded</th>
                                    <th>Status</th>
                                    <th>Admin Comments</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        {{ doc.document_type.title() }}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ doc.uploaded_at.strftime('%d %b %Y') }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if doc.verification_status == 'verified' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Verified
                                            </span>
                                        {% elif doc.verification_status == 'rejected' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Rejected
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Pending
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if doc.verification_notes %}
                                            <small class="text-muted">{{ doc.verification_notes[:50] }}...</small>
                                        {% else %}
                                            <small class="text-muted">No comments</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('static', filename=doc.file_path) }}" 
                                           target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No documents uploaded yet.</p>
                        <a href="{{ url_for('onboarding.onboarding_unified') }}" class="btn btn-outline-primary">
                            Upload Documents
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column - Quick Stats & Actions -->
        <div class="col-lg-4">
            
            <!-- Quick Stats -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3">Quick Stats</h6>
                    
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <div class="fs-4 fw-bold text-primary">{{ current_stage }}</div>
                                <small class="text-muted">Current Stage</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <div class="fs-4 fw-bold text-success">{{ user_badges|length }}</div>
                                <small class="text-muted">Badges Earned</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <div class="fs-4 fw-bold text-info">{{ doc_summary.total }}</div>
                                <small class="text-muted">Documents</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <div class="fs-4 fw-bold text-warning">{{ doc_summary.pending }}</div>
                                <small class="text-muted">Pending Review</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Public Profile -->
            {% if slug_page and slug_page.is_active %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-globe text-success me-2"></i>
                        Public Profile
                    </h6>
                    <p class="text-muted small mb-3">Your profile is live and visible to employers!</p>
                    <div class="d-grid">
                        <a href="{{ url_for('onboarding.public_coach_profile', slug=slug_page.slug) }}" 
                           target="_blank" class="btn btn-outline-success">
                            <i class="fas fa-external-link-alt me-2"></i>
                            View Public Profile
                        </a>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">{{ slug_page.page_views }} profile views</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3">Quick Actions</h6>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('onboarding.onboarding_unified') }}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>
                            Update Profile
                        </a>
                        <a href="{{ url_for('coach.coach_jobs') }}" class="btn btn-outline-primary">
                            <i class="fas fa-briefcase me-2"></i>
                            Browse Jobs
                        </a>
                        <a href="{{ url_for('coach.view_applications') }}" class="btn btn-outline-info">
                            <i class="fas fa-file-alt me-2"></i>
                            My Applications
                        </a>
                        {% if current_user.onboarding_completed %}
                        <a href="{{ url_for('membership.plans') }}" class="btn btn-outline-warning">
                            <i class="fas fa-crown me-2"></i>
                            Upgrade Membership
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Referral Section -->
            {% if current_user.referral_code %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-users text-warning me-2"></i>
                        Refer & Earn
                    </h6>
                    <p class="text-muted small mb-3">Share your referral code and earn 1000 coins for each successful referral!</p>
                    
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" value="{{ current_user.referral_code }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyReferralCode()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    
                    <small class="text-muted">
                        Referrals: {{ current_user.referred_by_code or 0 }} coaches joined
                    </small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copyReferralCode() {
    const input = document.querySelector('input[value="{{ current_user.referral_code }}"]');
    input.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>

{% endblock %}
</content>