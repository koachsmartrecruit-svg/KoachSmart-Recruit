{% extends "base.html" %}
{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- HEADER -->
      <div class="glass-card p-4 mb-4 text-center">
        <h2 class="fw-bold mb-1">AI Voice Resume Builder</h2>
        <p class="small text-muted">
          Speak naturally. We build the entire resume.
        </p>

        <!-- ЁЯФФ INSTRUCTIONS -->
        <div id="instructionsBox" class="alert alert-warning text-start small mb-3">
        <strong id="instructionTitle">
            рдЕрдЪреНрдЫреЗ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рд╕реЗ рдкрдврд╝реЗрдВ:
        </strong>

        <ul id="instructionList" class="mb-1 ps-3">
            <li>рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЕрдкрдирд╛ <b>рдкреВрд░рд╛ рдирд╛рдо рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ</b> рдмреЛрд▓реЗрдВ, рдлрд┐рд░ рдереЛрдбрд╝реА рджреЗрд░ рд░реБрдХреЗрдВ</li>
            <li><b>рдЫреЛрдЯреЗ рдФрд░ рд╕реНрдкрд╖реНрдЯ рд╡рд╛рдХреНрдпреЛрдВ</b> рдореЗрдВ рдмреЛрд▓реЗрдВ</li>
            <li>рдЕрдиреБрднрд╡ рдХреЛ <b>рд╕рд╛рд▓реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛</b> рдореЗрдВ рдмрддрд╛рдПрдВ</li>
            <li>рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмреЛрд▓реЗрдВ (рдЬреИрд╕реЗ: тАЬрдмреАрд╕реАрд╕реАрдЖрдИ рд▓реЗрд╡рд▓ рд╡рдитАЭ)</li>
        </ul>

        <div id="instructionExample" class="fst-italic text-muted">
            рдЙрджрд╛рд╣рд░рдг: <br>
            тАЬрдореЗрд░рд╛ рдирд╛рдо рдЕрдорд┐рдд рд╡рд░реНрдорд╛ рд╣реИред  
            рдореИрдВ рдлреБрдЯрдмреЙрд▓ рдХреЛрдЪ рд╣реВрдБред  
            рдореБрдЭреЗ рдкрд╛рдБрдЪ рд╕рд╛рд▓ рдХрд╛ рдЕрдиреБрднрд╡ рд╣реИред  
            рдореИрдВ рдПрдЖрдИрдПрдлрдПрдл рд▓реЗрд╡рд▓ рд╡рди рдкреНрд░рдорд╛рдгрд┐рдд рд╣реВрдБредтАЭ
        </div>
        </div>


        <!-- CONTROLS -->
        <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
          <select id="voiceLang" class="form-select form-select-sm w-auto">
            <option value="en-IN">English</option>
            <option value="hi-IN">Hindi</option>
          </select>

          <button id="startVoice" class="btn btn-success btn-sm">
            ЁЯОЩя╕П Start Recording
          </button>

          <button id="stopVoice" class="btn btn-danger btn-sm d-none">
            тП╣ Stop Recording
          </button>

          <span id="voiceStatus" class="small text-muted align-self-center"></span>
        </div>

        <button onclick="window.print()" class="btn btn-primary btn-sm">
          Download PDF
        </button>

        <p class="text-muted small mt-2">
          This resume is auto-generated using voice input. You can edit any section before downloading.
        </p>
      </div>

      <!-- RESUME -->
      <div id="printableResume" class="bg-white p-5 shadow rounded">

        <!-- NAME -->
        <div class="d-flex justify-content-between border-bottom pb-3 mb-4">
          <div>
            <h1 id="resumeName" class="fw-bold display-5" contenteditable="true">
              {{ profile.full_name }}
            </h1>
            <h5 id="resumeHeadline" class="text-primary fw-bold" contenteditable="true">
              {{ profile.sport }} Coach | {{ profile.experience_years }} Years
            </h5>
          </div>
          <div class="text-end small">
            <div contenteditable="true">{{ profile.user.email }}</div>
            <div contenteditable="true">{{ profile.phone }}</div>
          </div>
        </div>

        <!-- SUMMARY -->
        <section class="mb-4">
          <h4 class="fw-bold border-bottom pb-2">Professional Summary</h4>
          <p id="resumeSummary" contenteditable="true" class="lead">
            {{ ai_summary }}
          </p>
        </section>

        <!-- SKILLS -->
        <section class="mb-4">
          <h4 class="fw-bold border-bottom pb-2">Core Skills</h4>
          <div id="resumeSkills" class="d-flex flex-wrap gap-2" contenteditable="true">
            <span class="badge bg-primary">Coaching</span>
            <span class="badge bg-primary">Fitness</span>
          </div>
        </section>

        <!-- EXPERIENCE -->
        <section class="mb-4">
          <h4 class="fw-bold border-bottom pb-2">Experience</h4>
          <ul id="resumeExperience" class="list-unstyled">
            <li>
              <strong>Coach</strong>
              <p>Conducted training sessions.</p>
            </li>
          </ul>
        </section>

        <!-- CERTIFICATIONS -->
        <section class="mb-4">
          <h4 class="fw-bold border-bottom pb-2">Certifications</h4>
          <ul id="resumeCerts">
            <li>BCCI / AIFF Certified</li>
          </ul>
        </section>

        <!-- ACHIEVEMENTS -->
        <section>
          <h4 class="fw-bold border-bottom pb-2">Achievements</h4>
          <ul id="resumeAchievements">
            <li>Improved athlete performance</li>
          </ul>
        </section>

      </div>
    </div>
  </div>
</div>

<style>
[contenteditable="true"]:hover {
  background: rgba(255,255,0,.12);
  outline: 1px dashed #ccc;
}

@media print {
  body * { visibility: hidden; }
  #printableResume, #printableResume * { visibility: visible; }
  #printableResume {
    position:absolute;
    top:0;
    left:0;
    width:100%;
    box-shadow:none;
  }
  .glass-card { display:none; }
}
</style>

<script>
const voiceLangSelect = document.getElementById("voiceLang");

function updateInstructions(lang) {
  const title = document.getElementById("instructionTitle");
  const list = document.getElementById("instructionList");
  const example = document.getElementById("instructionExample");

  if (lang === "hi-IN") {
    // тЬЕ PURE HINDI
    title.innerText = "рдЕрдЪреНрдЫреЗ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рд╕реЗ рдкрдврд╝реЗрдВ:";

    list.innerHTML = `
      <li>рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рдЕрдкрдирд╛ <b>рдкреВрд░рд╛ рдирд╛рдо рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ</b> рдмреЛрд▓реЗрдВ, рдлрд┐рд░ рдереЛрдбрд╝реА рджреЗрд░ рд░реБрдХреЗрдВ</li>
      <li><b>рдЫреЛрдЯреЗ рдФрд░ рд╕реНрдкрд╖реНрдЯ рд╡рд╛рдХреНрдпреЛрдВ</b> рдореЗрдВ рдмреЛрд▓реЗрдВ</li>
      <li>рдЕрдиреБрднрд╡ рдХреЛ <b>рд╕рд╛рд▓реЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛</b> рдореЗрдВ рдмрддрд╛рдПрдВ</li>
      <li>рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмреЛрд▓реЗрдВ (рдЬреИрд╕реЗ: тАЬрдмреАрд╕реАрд╕реАрдЖрдИ рд▓реЗрд╡рд▓ рд╡рдитАЭ)</li>
    `;

    example.innerHTML = `
      рдЙрджрд╛рд╣рд░рдг: <br>
      тАЬрдореЗрд░рд╛ рдирд╛рдо рдЕрдорд┐рдд рд╡рд░реНрдорд╛ рд╣реИред  
      рдореИрдВ рдлреБрдЯрдмреЙрд▓ рдХреЛрдЪ рд╣реВрдБред  
      рдореБрдЭреЗ рдкрд╛рдБрдЪ рд╕рд╛рд▓ рдХрд╛ рдЕрдиреБрднрд╡ рд╣реИред  
      рдореИрдВ рдПрдЖрдИрдПрдлрдПрдл рд▓реЗрд╡рд▓ рд╡рди рдкреНрд░рдорд╛рдгрд┐рдд рд╣реВрдБредтАЭ
    `;
  } else {
    // тЬЕ PURE ENGLISH
    title.innerText = "How to get best results (please read):";

    list.innerHTML = `
      <li>Say your <b>full name clearly first</b>, then pause</li>
      <li>Speak in <b>short, clear sentences</b></li>
      <li>Mention experience as <b>number of years</b></li>
      <li>Say certifications clearly (example: тАЬBCCI Level OneтАЭ)</li>
    `;

    example.innerHTML = `
      Example: <br>
      тАЬMy name is Amit Varma.  
      I am a football coach.  
      I have five years experience.  
      I am AIFF Level One certified.тАЭ
    `;
  }
}

// Page load par set karo
updateInstructions(voiceLangSelect.value);

// Language change par update karo
voiceLangSelect.addEventListener("change", () => {
  updateInstructions(voiceLangSelect.value);
});
let mediaRecorder;
let audioChunks = [];

const startBtn = document.getElementById("startVoice");
const stopBtn = document.getElementById("stopVoice");
const status = document.getElementById("voiceStatus");

startBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioChunks = [];
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  startBtn.classList.add("d-none");
  stopBtn.classList.remove("d-none");
  status.innerText = "ЁЯОЩя╕П Recording... Click Stop when finished";
};

stopBtn.onclick = async () => {
  mediaRecorder.stop();

  startBtn.classList.remove("d-none");
  stopBtn.classList.add("d-none");
  status.innerText = "тП│ Processing voice...";

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
    const formData = new FormData();
    formData.append("audio", audioBlob);

    const res = await fetch("/voice-to-resume", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    document.getElementById("resumeName").innerText = data.full_name;
    document.getElementById("resumeHeadline").innerText = data.headline;
    document.getElementById("resumeSummary").innerText = data.summary;

    const skills = document.getElementById("resumeSkills");
    skills.innerHTML = "";
    data.skills.forEach(s =>
      skills.innerHTML += `<span class="badge bg-primary">${s}</span>`
    );

    const exp = document.getElementById("resumeExperience");
    exp.innerHTML = "";
    data.experience.forEach(e =>
      exp.innerHTML += `<li><strong>${e.role}</strong><p>${e.description}</p></li>`
    );

    const certs = document.getElementById("resumeCerts");
    certs.innerHTML = "";
    data.certifications.forEach(c =>
      certs.innerHTML += `<li>${c}</li>`
    );

    const ach = document.getElementById("resumeAchievements");
    ach.innerHTML = "";
    data.achievements.forEach(a =>
      ach.innerHTML += `<li>${a}</li>`
    );

    status.innerText = "тЬЕ Resume updated successfully";
  };
};
</script>

{% endblock %}
